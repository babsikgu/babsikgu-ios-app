name: iOS IPA Node22
on: [push]
jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'  # Capacitor 요구사항 충족
          cache: 'npm'
      - run: npm install
      - run: npm i @capacitor/cli@latest @capacitor/core@latest @capacitor/ios@latest
      - run: npx cap init babsikgu com.babsikgu.map --web-dir www || true
      - run: npx cap add ios
      - run: npx cap copy ios
      - run: npx cap sync ios
      - name: Export Plist
        run: |
          cat > ios/App/export.plist << EOF
          <?xml version="1.0"?>
          <!DOCTYPE plist>
          <plist>
          <dict>
            <key>method</key><string>development</string>
          </dict>
          </plist>
          EOF
      - name: Archive & Export
        run: |
          cd ios/App
          xcodebuild archive -workspace App.xcworkspace -scheme App \
            -configuration Release CODE_SIGNING_ALLOWED=NO \
            -archivePath ../App.xcarchive
          xcodebuild -exportArchive -archivePath ../App.xcarchive \
            -exportOptionsPlist export.plist -exportPath ../build
      - uses: actions/upload-artifact@v4
        with:
          name: final-ipa
          path: ios/build/*.ipa
